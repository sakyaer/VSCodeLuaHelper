"use strict";
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
Object.defineProperty(exports, "__esModule", { value: true });
const ee = require("events");
class ProtocolClient extends ee.EventEmitter {
    constructor() {
        super();
        this.pendingRequests = new Map();
        this.rawData = new Buffer(0);
        this.sequence = 1;
        this.contentLength = -1;
    }
    connect(readable, writable) {
        this.outputStream = writable;
        readable.on('data', (data) => {
            this.handleData(data);
        });
    }
    send(command, args) {
        return new Promise((completeDispatch, errorDispatch) => {
            this.doSend(command, args, (result) => {
                if (result.success) {
                    completeDispatch(result);
                }
                else {
                    errorDispatch(new Error(result.message));
                }
            });
        });
    }
    doSend(command, args, clb) {
        const request = {
            type: 'request',
            seq: this.sequence++,
            command: command
        };
        if (args && Object.keys(args).length > 0) {
            request.arguments = args;
        }
        // store callback for this request
        this.pendingRequests.set(request.seq, clb);
        const json = JSON.stringify(request);
        this.outputStream.write(`Content-Length: ${Buffer.byteLength(json, 'utf8')}\r\n\r\n${json}`, 'utf8');
    }
    handleData(data) {
        this.rawData = Buffer.concat([this.rawData, data]);
        while (true) {
            if (this.contentLength >= 0) {
                if (this.rawData.length >= this.contentLength) {
                    const message = this.rawData.toString('utf8', 0, this.contentLength);
                    this.rawData = this.rawData.slice(this.contentLength);
                    this.contentLength = -1;
                    if (message.length > 0) {
                        this.dispatch(message);
                    }
                    continue; // there may be more complete messages to process
                }
            }
            else {
                const idx = this.rawData.indexOf(ProtocolClient.TWO_CRLF);
                if (idx !== -1) {
                    const header = this.rawData.toString('utf8', 0, idx);
                    const lines = header.split('\r\n');
                    for (let i = 0; i < lines.length; i++) {
                        const pair = lines[i].split(/: +/);
                        if (pair[0] === 'Content-Length') {
                            this.contentLength = +pair[1];
                        }
                    }
                    this.rawData = this.rawData.slice(idx + ProtocolClient.TWO_CRLF.length);
                    continue;
                }
            }
            break;
        }
    }
    dispatch(body) {
        const rawData = JSON.parse(body);
        if (typeof rawData.event !== 'undefined') {
            const event = rawData;
            this.emit(event.event, event);
        }
        else {
            const response = rawData;
            const clb = this.pendingRequests.get(response.request_seq);
            if (clb) {
                this.pendingRequests.delete(response.request_seq);
                clb(response);
            }
        }
    }
}
ProtocolClient.TWO_CRLF = '\r\n\r\n';
exports.ProtocolClient = ProtocolClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdG9jb2xDbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcHJvdG9jb2xDbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Z0dBR2dHOztBQUdoRyw2QkFBNkI7QUFHN0Isb0JBQTRCLFNBQVEsRUFBRSxDQUFDLFlBQVk7SUFVbEQ7UUFDQyxLQUFLLEVBQUUsQ0FBQztRQUxELG9CQUFlLEdBQUcsSUFBSSxHQUFHLEVBQStDLENBQUM7UUFDekUsWUFBTyxHQUFHLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBSy9CLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVTLE9BQU8sQ0FBQyxRQUF5QixFQUFFLFFBQXlCO1FBRXJFLElBQUksQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDO1FBRTdCLFFBQVEsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBWSxFQUFFLEVBQUU7WUFDcEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2QixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFrQ00sSUFBSSxDQUFDLE9BQWUsRUFBRSxJQUFVO1FBRXRDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLGdCQUFnQixFQUFFLGFBQWEsRUFBRSxFQUFFO1lBQ3RELElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLE1BQThCLEVBQUUsRUFBRTtnQkFDN0QsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7b0JBQ3BCLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUMxQixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNQLGFBQWEsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxD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LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4gU2VlIExpY2Vuc2UudHh0IGluIHRoZSBwcm9qZWN0IHJvb3QgZm9yIGxpY2Vuc2UgaW5mb3JtYXRpb24uXG4gKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cblxuaW1wb3J0IHN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpO1xuaW1wb3J0ICogYXMgZWUgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7RGVidWdQcm90b2NvbH0gZnJvbSAndnNjb2RlLWRlYnVncHJvdG9jb2wnO1xuXG5leHBvcnQgY2xhc3MgUHJvdG9jb2xDbGllbnQgZXh0ZW5kcyBlZS5FdmVudEVtaXR0ZXIge1xuXG5cdHByaXZhdGUgc3RhdGljIFRXT19DUkxGID0gJ1xcclxcblxcclxcbic7XG5cblx0cHJpdmF0ZSBvdXRwdXRTdHJlYW06IHN0cmVhbS5Xcml0YWJsZTtcblx0cHJpdmF0ZSBzZXF1ZW5jZTogbnVtYmVyO1xuXHRwcml2YXRlIHBlbmRpbmdSZXF1ZXN0cyA9IG5ldyBNYXA8bnVtYmVyLCAoZTogRGVidWdQcm90b2NvbC5SZXNwb25zZSkgPT4gdm9pZD4oKTtcblx0cHJpdmF0ZSByYXdEYXRhID0gbmV3IEJ1ZmZlcigwKTtcblx0cHJpdmF0ZSBjb250ZW50TGVuZ3RoOiBudW1iZXI7XG5cblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0c3VwZXIoKTtcblx0XHR0aGlzLnNlcXVlbmNlID0gMTtcblx0XHR0aGlzLmNvbnRlbnRMZW5ndGggPSAtMTtcblx0fVxuXG5cdHByb3RlY3RlZCBjb25uZWN0KHJlYWRhYmxlOiBzdHJlYW0uUmVhZGFibGUsIHdyaXRhYmxlOiBzdHJlYW0uV3JpdGFibGUpOiB2b2lkIHtcblxuXHRcdHRoaXMub3V0cHV0U3RyZWFtID0gd3JpdGFibGU7XG5cblx0XHRyZWFkYWJsZS5vbignZGF0YScsIChkYXRhOiBCdWZmZXIpID0+IHtcblx0XHRcdHRoaXMuaGFuZGxlRGF0YShkYXRhKTtcblx0XHR9KTtcblx0fVxuXG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdpbml0aWFsaXplJywgYXJnczogRGVidWdQcm90b2NvbC5Jbml0aWFsaXplUmVxdWVzdEFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuSW5pdGlhbGl6ZVJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2NvbmZpZ3VyYXRpb25Eb25lJywgYXJnczogRGVidWdQcm90b2NvbC5Db25maWd1cmF0aW9uRG9uZUFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuQ29uZmlndXJhdGlvbkRvbmVSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdsYXVuY2gnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkxhdW5jaFJlcXVlc3RBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkxhdW5jaFJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2F0dGFjaCcsIGFyZ3M6IERlYnVnUHJvdG9jb2wuQXR0YWNoUmVxdWVzdEFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuQXR0YWNoUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAncmVzdGFydCcsIGFyZ3M6IERlYnVnUHJvdG9jb2wuUmVzdGFydEFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuUmVzdGFydFJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2Rpc2Nvbm5lY3QnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkRpc2Nvbm5lY3RBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkRpc2Nvbm5lY3RSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzZXRCcmVha3BvaW50cycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU2V0QnJlYWtwb2ludHNBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlNldEJyZWFrcG9pbnRzUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc2V0RnVuY3Rpb25CcmVha3BvaW50cycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU2V0RnVuY3Rpb25CcmVha3BvaW50c0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU2V0RnVuY3Rpb25CcmVha3BvaW50c1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3NldEV4Y2VwdGlvbkJyZWFrcG9pbnRzJywgYXJnczogRGVidWdQcm90b2NvbC5TZXRFeGNlcHRpb25CcmVha3BvaW50c0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU2V0RXhjZXB0aW9uQnJlYWtwb2ludHNSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdjb250aW51ZScsIGFyZ3M6IERlYnVnUHJvdG9jb2wuQ29udGludWVBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkNvbnRpbnVlUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnbmV4dCcsIGFyZ3M6IERlYnVnUHJvdG9jb2wuTmV4dEFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuTmV4dFJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3N0ZXBJbicsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU3RlcEluQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5TdGVwSW5SZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzdGVwT3V0JywgYXJnczogRGVidWdQcm90b2NvbC5TdGVwT3V0QXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5TdGVwT3V0UmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc3RlcEJhY2snLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlN0ZXBCYWNrQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5TdGVwQmFja1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3JldmVyc2VDb250aW51ZScsIGFyZ3M6IERlYnVnUHJvdG9jb2wuUmV2ZXJzZUNvbnRpbnVlQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5SZXZlcnNlQ29udGludWVSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdyZXN0YXJ0RnJhbWUnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlJlc3RhcnRGcmFtZUFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuUmVzdGFydEZyYW1lUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnZ290bycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuR290b0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuR290b1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3BhdXNlJywgYXJnczogRGVidWdQcm90b2NvbC5QYXVzZUFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuUGF1c2VSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzdGFja1RyYWNlJywgYXJnczogRGVidWdQcm90b2NvbC5TdGFja1RyYWNlQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5TdGFja1RyYWNlUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc2NvcGVzJywgYXJnczogRGVidWdQcm90b2NvbC5TY29wZXNBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlNjb3Blc1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3ZhcmlhYmxlcycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuVmFyaWFibGVzQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5WYXJpYWJsZXNSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzZXRWYXJpYWJsZScsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU2V0VmFyaWFibGVBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlNldFZhcmlhYmxlUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc291cmNlJywgYXJnczogRGVidWdQcm90b2NvbC5Tb3VyY2VBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlNvdXJjZVJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3RocmVhZHMnKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5UaHJlYWRzUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnbW9kdWxlcycpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLk1vZHVsZXNSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdldmFsdWF0ZScsIGFyZ3M6IERlYnVnUHJvdG9jb2wuRXZhbHVhdGVBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkV2YWx1YXRlUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc3RlcEluVGFyZ2V0cycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU3RlcEluVGFyZ2V0c0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU3RlcEluVGFyZ2V0c1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2dvdG9UYXJnZXRzJywgYXJnczogRGVidWdQcm90b2NvbC5Hb3RvVGFyZ2V0c0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuR290b1RhcmdldHNSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdjb21wbGV0aW9ucycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuQ29tcGxldGlvbnNBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkNvbXBsZXRpb25zUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnZXhjZXB0aW9uSW5mbycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuRXhjZXB0aW9uSW5mb0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuRXhjZXB0aW9uSW5mb1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogc3RyaW5nLCBhcmdzPzogYW55KSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5SZXNwb25zZT47XG5cblx0cHVibGljIHNlbmQoY29tbWFuZDogc3RyaW5nLCBhcmdzPzogYW55KTogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlPiB7XG5cblx0XHRyZXR1cm4gbmV3IFByb21pc2UoKGNvbXBsZXRlRGlzcGF0Y2gsIGVycm9yRGlzcGF0Y2gpID0+IHtcblx0XHRcdHRoaXMuZG9TZW5kKGNvbW1hbmQsIGFyZ3MsIChyZXN1bHQ6IERlYnVnUHJvdG9jb2wuUmVzcG9uc2UpID0+IHtcblx0XHRcdFx0aWYgKHJlc3VsdC5zdWNjZXNzKSB7XG5cdFx0XHRcdFx0Y29tcGxldGVEaXNwYXRjaChyZXN1bHQpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGVycm9yRGlzcGF0Y2gobmV3IEVycm9yKHJlc3VsdC5tZXNzYWdlKSk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdH0pO1xuXHR9XG5cblx0cHJpdmF0ZSBkb1NlbmQoY29tbWFuZDogc3RyaW5nLCBhcmdzOiBhbnksIGNsYjogKHJlc3VsdDogRGVidWdQcm90b2NvbC5SZXNwb25zZSkgPT4gdm9pZCk6IHZvaWQge1xuXG5cdFx0Y29uc3QgcmVxdWVzdDogRGVidWdQcm90b2NvbC5SZXF1ZXN0ID0ge1xuXHRcdFx0dHlwZTogJ3JlcXVlc3QnLFxuXHRcdFx0c2VxOiB0aGlzLnNlcXVlbmNlKyssXG5cdFx0XHRjb21tYW5kOiBjb21tYW5kXG5cdFx0fTtcblx0XHRpZiAoYXJncyAmJiBPYmplY3Qua2V5cyhhcmdzKS5sZW5ndGggPiAwKSB7XG5cdFx0XHRyZXF1ZXN0LmFyZ3VtZW50cyA9IGFyZ3M7XG5cdFx0fVxuXG5cdFx0Ly8gc3RvcmUgY2FsbGJhY2sgZm9yIHRoaXMgcmVxdWVzdFxuXHRcdHRoaXMucGVuZGluZ1JlcXVlc3RzLnNldChyZXF1ZXN0LnNlcSwgY2xiKTtcblxuXHRcdGNvbnN0IGpzb24gPSBKU09OLnN0cmluZ2lmeShyZXF1ZXN0KTtcblx0XHR0aGlzLm91dHB1dFN0cmVhbS53cml0ZShgQ29udGVudC1MZW5ndGg6ICR7QnVmZmVyLmJ5dGVMZW5ndGgoanNvbiwgJ3V0ZjgnKX1cXHJcXG5cXHJcXG4ke2pzb259YCwgJ3V0ZjgnKTtcblx0fVxuXG5cdHByaXZhdGUgaGFuZGxlRGF0YShkYXRhOiBCdWZmZXIpOiB2b2lkIHtcblxuXHRcdHRoaXMucmF3RGF0YSA9IEJ1ZmZlci5jb25jYXQoW3RoaXMucmF3RGF0YSwgZGF0YV0pO1xuXG5cdFx0d2hpbGUgKHRydWUpIHtcblx0XHRcdGlmICh0aGlzLmNvbnRlbnRMZW5ndGggPj0gMCkge1xuXHRcdFx0XHRpZiAodGhpcy5yYXdEYXRhLmxlbmd0aCA+PSB0aGlzLmNvbnRlbnRMZW5ndGgpIHtcblx0XHRcdFx0XHRjb25zdCBtZXNzYWdlID0gdGhpcy5yYXdEYXRhLnRvU3RyaW5nKCd1dGY4JywgMCwgdGhpcy5jb250ZW50TGVuZ3RoKTtcblx0XHRcdFx0XHR0aGlzLnJhd0RhdGEgPSB0aGlzLnJhd0RhdGEuc2xpY2UodGhpcy5jb250ZW50TGVuZ3RoKTtcblx0XHRcdFx0XHR0aGlzLmNvbnRlbnRMZW5ndGggPSAtMTtcblx0XHRcdFx0XHRpZiAobWVzc2FnZS5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdFx0XHR0aGlzLmRpc3BhdGNoKG1lc3NhZ2UpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRjb250aW51ZTtcdC8vIHRoZXJlIG1heSBiZSBtb3JlIGNvbXBsZXRlIG1lc3NhZ2VzIHRvIHByb2Nlc3Ncblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0Y29uc3QgaWR4ID0gdGhpcy5yYXdEYXRhLmluZGV4T2YoUHJvdG9jb2xDbGllbnQuVFdPX0NSTEYpO1xuXHRcdFx0XHRpZiAoaWR4ICE9PSAtMSkge1xuXHRcdFx0XHRcdGNvbnN0IGhlYWRlciA9IHRoaXMucmF3RGF0YS50b1N0cmluZygndXRmOCcsIDAsIGlkeCk7XG5cdFx0XHRcdFx0Y29uc3QgbGluZXMgPSBoZWFkZXIuc3BsaXQoJ1xcclxcbicpO1xuXHRcdFx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspIHtcblx0XHRcdFx0XHRcdGNvbnN0IHBhaXIgPSBsaW5lc1tpXS5zcGxpdCgvOiArLyk7XG5cdFx0XHRcdFx0XHRpZiAocGFpclswXSA9PT0gJ0NvbnRlbnQtTGVuZ3RoJykge1xuXHRcdFx0XHRcdFx0XHR0aGlzLmNvbnRlbnRMZW5ndGggPSArcGFpclsxXTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0dGhpcy5yYXdEYXRhID0gdGhpcy5yYXdEYXRhLnNsaWNlKGlkeCArIFByb3RvY29sQ2xpZW50LlRXT19DUkxGLmxlbmd0aCk7XG5cdFx0XHRcdFx0Y29udGludWU7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdGJyZWFrO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgZGlzcGF0Y2goYm9keTogc3RyaW5nKTogdm9pZCB7XG5cblx0XHRjb25zdCByYXdEYXRhID0gSlNPTi5wYXJzZShib2R5KTtcblxuXHRcdGlmICh0eXBlb2YgcmF3RGF0YS5ldmVudCAhPT0gJ3VuZGVmaW5lZCcpIHtcblx0XHRcdGNvbnN0IGV2ZW50ID0gPERlYnVnUHJvdG9jb2wuRXZlbnQ+IHJhd0RhdGE7XG5cdFx0XHR0aGlzLmVtaXQoZXZlbnQuZXZlbnQsIGV2ZW50KTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc3QgcmVzcG9uc2UgPSA8RGVidWdQcm90b2NvbC5SZXNwb25zZT4gcmF3RGF0YTtcblx0XHRcdGNvbnN0IGNsYiA9IHRoaXMucGVuZGluZ1JlcXVlc3RzLmdldChyZXNwb25zZS5yZXF1ZXN0X3NlcSk7XG5cdFx0XHRpZiAoY2xiKSB7XG5cdFx0XHRcdHRoaXMucGVuZGluZ1JlcXVlc3RzLmRlbGV0ZShyZXNwb25zZS5yZXF1ZXN0X3NlcSk7XG5cdFx0XHRcdGNsYihyZXNwb25zZSk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG59XG4iXX0=